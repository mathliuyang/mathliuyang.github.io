<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>学术提示词生成器</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg: #000000;
            --text: #ffffff;
            --text-dim: #666666;
            --accent: #ffffff;
            --border: rgba(255, 255, 255, 0.08);
            --card-bg: rgba(255, 255, 255, 0.03);
        }

        [data-theme="light"] {
            --bg: #ffffff;
            --text: #000000;
            --text-dim: #999999;
            --accent: #000000;
            --border: rgba(0, 0, 0, 0.08);
            --card-bg: rgba(0, 0, 0, 0.03);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.8;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            letter-spacing: -0.02em;
            min-height: 100vh;
        }

        nav {
            position: fixed;
            top: 0;
            width: 100%;
            padding: 1.5rem 4rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border);
        }

        [data-theme="light"] nav {
            background: rgba(255, 255, 255, 0.8);
        }

        .logo {
            font-size: 1rem;
            font-weight: 600;
            letter-spacing: 0.05em;
            cursor: pointer;
        }

        .nav-right {
            display: flex;
            gap: 3rem;
            align-items: center;
        }

        .nav-links {
            display: flex;
            gap: 2.5rem;
            list-style: none;
        }

        .nav-links a {
            color: var(--text);
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: 500;
            letter-spacing: 0.02em;
            transition: color 0.3s ease;
            opacity: 0.6;
        }

        .nav-links a:hover,
        .nav-links a.active {
            opacity: 1;
        }

        .back-btn {
            display: inline-block;
            margin: 2rem 0;
            padding: 0.8rem 1.5rem;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--text);
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: 500;
            letter-spacing: 0.02em;
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            border-color: var(--text);
            color: var(--bg);
            background: var(--text);
        }

        .theme-btn {
            width: 36px;
            height: 36px;
            border: 1px solid var(--border);
            background: transparent;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .theme-btn:hover {
            border-color: var(--text);
            transform: scale(1.1);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 120px 4rem 4rem;
        }

        .header {
            margin-bottom: 3rem;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 300;
            margin-bottom: 0.5rem;
            letter-spacing: -0.02em;
        }

        .header p {
            color: var(--text-dim);
        }

        .mode-tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 3rem;
            border-bottom: 1px solid var(--border);
        }

        .tab {
            padding: 1rem 2rem;
            background: transparent;
            border: none;
            color: var(--text-dim);
            cursor: pointer;
            font-size: 0.95rem;
            letter-spacing: 0.05em;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .tab:hover {
            color: var(--text);
        }

        .tab.active {
            color: var(--text);
            border-bottom-color: var(--text);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* 密码验证模态框样式 */
        .password-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            backdrop-filter: blur(10px);
        }

        .password-container {
            background: var(--bg);
            border: 1px solid var(--border);
            padding: 3rem;
            border-radius: 8px;
            text-align: center;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .password-title {
            font-size: 1.5rem;
            margin-bottom: 1rem;
            color: var(--text);
        }

        .password-subtitle {
            color: var(--text-dim);
            margin-bottom: 2rem;
            font-size: 0.9rem;
        }

        .password-input {
            width: 100%;
            padding: 1rem;
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text);
            font-size: 1rem;
            margin-bottom: 1.5rem;
            border-radius: 4px;
            text-align: center;
            font-family: inherit;
            line-height: 1.4;
        }

        .password-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.1);
        }

        .password-btn {
            width: 100%;
            padding: 1rem;
            background: var(--text);
            color: var(--bg);
            border: 1px solid var(--text);
            font-size: 0.9rem;
            font-weight: 500;
            letter-spacing: 0.05em;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
        }

        .password-btn:hover {
            background: transparent;
            color: var(--text);
        }

        .password-error {
            color: #ff4757;
            font-size: 0.8rem;
            margin-top: 0.5rem;
            display: none;
        }

        .password-hint {
            color: var(--text-dim);
            font-size: 0.75rem;
            margin-top: 1rem;
            font-style: italic;
        }

        /* 主要内容初始隐藏 */
        .main-content {
            display: none;
        }

        .main-content.authenticated {
            display: block;
        }

        /* Generator Mode */
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 3rem;
        }

        .panel {
            border: 1px solid var(--border);
            padding: 2rem;
        }

        .panel-title {
            font-size: 1.2rem;
            font-weight: 500;
            margin-bottom: 1.5rem;
            letter-spacing: -0.01em;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .dynamic-form-indicator {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .empty-state {
            background: var(--bg-secondary);
            border: 2px dashed var(--border);
            border-radius: 1rem;
            margin: 2rem 0;
            transition: all 0.3s ease;
        }

        .empty-state:hover {
            border-color: var(--primary);
            background: var(--bg-primary);
        }

        .form-label.required::after {
            content: ' *';
            color: #ff4757;
            font-weight: bold;
        }

        .form-label {
            display: block;
            font-size: 0.85rem;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            color: var(--text-dim);
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .form-label .required {
            color: #ff4757;
            margin-left: 2px;
        }

        .form-input,
        .form-textarea,
        .form-select {
            width: 100%;
            padding: 0.8rem;
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text);
            font-size: 0.95rem;
            font-family: inherit;
            transition: all 0.3s ease;
            border-radius: 4px;
        }

        .form-input:focus,
        .form-textarea:focus,
        .form-select:focus {
            outline: none;
            border-color: var(--text);
            box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.1);
        }

        .form-input.error,
        .form-textarea.error,
        .form-select.error {
            border-color: #ff4757;
            box-shadow: 0 0 0 2px rgba(255, 71, 87, 0.2);
        }

        .form-input[required],
        .form-textarea[required],
        .form-select[required] {
            position: relative;
        }

        .form-input[required]:invalid,
        .form-textarea[required]:invalid,
        .form-select[required]:invalid {
            border-color: #ff6b7a;
        }

        /* Message styles */
        .error-message {
            background-color: #fdf2f2;
            color: #e74c3c;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #e74c3c;
            margin: 10px 0;
            font-size: 14px;
        }

        .info-message {
            background-color: #f0f8ff;
            color: #2980b9;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #3498db;
            margin: 10px 0;
            font-size: 14px;
        }

        .error-text {
            color: #e74c3c;
            font-size: 12px;
            margin-top: 4px;
            display: block;
        }

        .form-textarea {
            min-height: 120px;
            resize: vertical;
            font-family: inherit;
        }

        .form-select {
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%23ffffff' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
        }

        [data-theme="light"] .form-select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%23000000' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
        }

        /* 动态表单特殊样式 */
        .dynamic-form-indicator {
            position: absolute;
            top: -0.5rem;
            right: 0;
            background: var(--accent);
            color: var(--bg);
            padding: 0.2rem 0.5rem;
            font-size: 0.7rem;
            border-radius: 2px;
            font-weight: 600;
            letter-spacing: 0.05em;
            text-transform: uppercase;
        }

        .template-selector-group {
            margin-bottom: 2rem;
            padding: 1.5rem;
            border: 2px dashed var(--border);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.02);
            transition: all 0.3s ease;
        }

        .template-selector-group:hover {
            border-color: var(--text);
            background: rgba(255, 255, 255, 0.05);
        }

        .template-selector-group .form-label {
            color: var(--text);
            font-size: 0.9rem;
            margin-bottom: 0.8rem;
        }

        .radio-group {
            display: flex;
            gap: 1.5rem;
            flex-wrap: wrap;
        }

        .radio-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
        }

        .radio-item input[type="radio"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        .generate-btn {
            width: 100%;
            padding: 1rem;
            background: var(--text);
            color: var(--bg);
            border: 1px solid var(--text);
            font-size: 0.9rem;
            font-weight: 500;
            letter-spacing: 0.05em;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            margin-top: 1rem;
        }

        .generate-btn:hover {
            background: transparent;
            color: var(--text);
        }

        .output-textarea {
            width: 100%;
            min-height: 400px;
            padding: 1.5rem;
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text);
            font-size: 0.95rem;
            font-family: 'Courier New', monospace;
            line-height: 1.6;
            resize: vertical;
        }

        .output-textarea:focus {
            outline: none;
            border-color: var(--text);
        }

        .output-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }

        .action-btn {
            flex: 1;
            padding: 0.8rem;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--text);
            font-size: 0.85rem;
            letter-spacing: 0.05em;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
        }

        .action-btn:hover {
            background: var(--text);
            color: var(--bg);
            border-color: var(--text);
        }

        /* Templates Mode */
        .filter-section {
            margin-bottom: 3rem;
            padding-bottom: 2rem;
            border-bottom: 1px solid var(--border);
        }

        .filter-title {
            font-size: 1.2rem;
            font-weight: 500;
            margin-bottom: 1.5rem;
            letter-spacing: -0.01em;
        }

        .filter-buttons {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 0.8rem 1.5rem;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--text-dim);
            font-size: 0.85rem;
            font-weight: 500;
            letter-spacing: 0.02em;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 4px;
            white-space: nowrap;
        }

        .filter-btn:hover {
            color: var(--text);
            border-color: var(--text);
        }

        .filter-btn.active {
            background: var(--text);
            color: var(--bg);
            border-color: var(--text);
        }

        .templates-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 2rem;
        }

        .template-card {
            border: 1px solid var(--border);
            padding: 2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .template-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 1px;
            background: var(--accent);
            transform: scaleX(0);
            transform-origin: left;
            transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .template-card:hover::before {
            transform: scaleX(1);
        }

        .template-card:hover {
            border-color: var(--text);
            transform: translateY(-5px);
        }

        .template-cover {
            width: 100%;
            height: 120px;
            margin-bottom: 1.5rem;
            border-radius: 4px;
            overflow: hidden;
            background: var(--border);
            position: relative;
        }

        .template-cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }

        .template-card:hover .template-cover img {
            transform: scale(1.05);
        }

        .template-icon {
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }

        .template-name {
            font-size: 1.3rem;
            font-weight: 500;
            margin-bottom: 0.8rem;
        }

        .template-desc {
            font-size: 0.9rem;
            color: var(--text-dim);
            line-height: 1.6;
            margin-bottom: 1rem;
        }

        .template-tags {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .tag {
            padding: 0.3rem 0.8rem;
            border: 1px solid var(--border);
            font-size: 0.75rem;
            letter-spacing: 0.05em;
            color: var(--text-dim);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: var(--bg);
            border: 1px solid var(--border);
            max-width: 900px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            padding: 3rem;
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: 1.5rem;
            right: 1.5rem;
            width: 40px;
            height: 40px;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--text);
            cursor: pointer;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .modal-close:hover {
            border-color: var(--text);
            background: var(--text);
            color: var(--bg);
        }

        .modal-title {
            font-size: 2rem;
            font-weight: 300;
            margin-bottom: 2rem;
        }

        .modal-template {
            background: var(--border);
            padding: 2rem;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            line-height: 1.8;
            white-space: pre-wrap;
            margin-bottom: 2rem;
            max-height: 400px;
            overflow-y: auto;
        }

        .modal-actions {
            display: flex;
            gap: 1rem;
        }

        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            padding: 1rem 1.5rem;
            background: var(--text);
            color: var(--bg);
            border: 1px solid var(--text);
            font-size: 0.9rem;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s ease;
            pointer-events: none;
            z-index: 1000;
        }

        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }

        @media (max-width: 1024px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            nav {
                padding: 1rem 2rem;
            }

            .container {
                padding: 100px 2rem 2rem;
            }

            .mode-tabs {
                overflow-x: auto;
            }

            .templates-grid {
                grid-template-columns: 1fr;
            }

            .modal-content {
                padding: 2rem 1.5rem;
            }

            .modal-actions {
                flex-direction: column;
            }
        }
    </style>
</head>

<body>
    <!-- 密码验证模态框 -->
    <div id="passwordModal" class="password-modal">
        <div class="password-container">
            <h2 class="password-title">访问验证</h2>
            <p class="password-subtitle">请输入访问密码以使用学术提示词生成器</p>
            <input type="text" id="passwordInput" class="password-input" placeholder="请输入密码" autocomplete="off"
                autocapitalize="off" autocorrect="off">
            <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                <a href="../pages/tools.html" class="password-btn"
                    style="flex: 1; background: transparent; color: var(--text); text-decoration: none; text-align: center;">返回工具集</a>
                <button onclick="checkPassword()" class="password-btn" style="flex: 1;">验证</button>
            </div>
            <div id="passwordError" class="password-error">密码错误，请重试</div>
            <p class="password-hint">功能测试中，暂未开放</p>
        </div>
    </div>

    <!-- 主要内容容器 -->
    <div id="mainContent" class="main-content">
        <nav>
            <div class="logo" onclick="location.href='../index.html'">图灵的猫 X 智核学术</div>
            <div class="nav-right">
                <ul class="nav-links">
                    <li><a href="../index.html">首页</a></li>
                    <li><a href="../pages/about.html">关于我</a></li>
                    <li><a href="../pages/blog.html">博客</a></li>
                    <li><a href="../pages/projects.html">项目</a></li>
                    <li><a href="../pages/publications.html">学术成果</a></li>
                    <li><a href="../pages/tools.html" class="active">工具箱</a></li>
                    <li><a href="../pages/contact.html">联系我</a></li>
                </ul>
                <button class="theme-btn" id="themeBtn">
                    <span id="themeIcon">◐</span>
                </button>
            </div>
        </nav>

        <div class="container">
            <div class="header">
                <h1>学术提示词生成器</h1>
                <p>智能生成高质量的学术写作提示词，或从模板库中选择预设提示词</p>
            </div>

            <div class="mode-tabs">
                <button class="tab active" onclick="switchTab('generator')">智能生成</button>
                <button class="tab" onclick="switchTab('templates')">模板库</button>
            </div>

            <!-- Generator Mode -->
            <div id="generator" class="tab-content active">
                <div class="main-grid">
                    <div class="panel">
                        <h2 class="panel-title">配置参数</h2>

                        <div class="template-selector-group">
                            <label class="form-label">选择模板</label>
                            <select class="form-select" id="templateSelect" onchange="loadTemplate()">
                                <option value="">请选择模板...</option>
                            </select>
                        </div>

                        <!-- 动态表单容器 -->
                        <div id="dynamicForm">
                            <!-- 未选择模板时的空状态 -->
                            <div class="empty-state">
                                <div style="text-align: center; padding: 3rem 0; color: var(--text-dim);">
                                    <div style="font-size: 3rem; margin-bottom: 1rem;">📝</div>
                                    <h3 style="margin-bottom: 1rem; color: var(--text);">选择模板开始使用</h3>
                                    <p>请从上方选择模板</p>
                                </div>
                            </div>
                        </div>

                        <button class="generate-btn" onclick="generatePrompt()">生成提示词</button>
                    </div>

                    <div class="panel">
                        <h2 class="panel-title">生成结果</h2>
                        <textarea class="output-textarea" id="output" placeholder="配置参数后点击生成..."></textarea>
                        <div class="output-actions">
                            <button class="action-btn" onclick="copyOutput()">复制</button>
                            <button class="action-btn" onclick="savePrompt()">保存</button>
                            <button class="action-btn" onclick="clearOutput()">清空</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Templates Mode -->
            <div id="templates" class="tab-content">
                <!-- 筛选功能 -->
                <div class="filter-section">
                    <h3 class="filter-title">按来源筛选</h3>
                    <div class="filter-buttons">
                        <button class="filter-btn active" data-category="all"
                            onclick="filterTemplates('all')">全部</button>
                        <button class="filter-btn" data-category="国自科基金申请指令"
                            onclick="filterTemplates('国自科基金申请指令')">国自科基金申请指令</button>
                        <button class="filter-btn" data-category="SCI论文写作全指南"
                            onclick="filterTemplates('SCI论文写作全指南')">SCI论文写作全指南</button>
                        <button class="filter-btn" data-category="常用工具" onclick="filterTemplates('常用工具')">常用工具</button>
                    </div>
                </div>
                <div class="templates-grid" id="templatesGrid"></div>
            </div>
        </div>

        <!-- Template Modal -->
        <div class="modal" id="templateModal">
            <div class="modal-content">
                <button class="modal-close" onclick="closeModal()">×</button>
                <h2 class="modal-title" id="modalTitle"></h2>
                <div class="modal-template" id="modalTemplate"></div>
                <div class="modal-actions">
                    <button class="action-btn" onclick="copyTemplate()">复制提示词</button>
                    <button class="action-btn" onclick="useTemplate()">使用此模板</button>
                </div>
            </div>
        </div>

        <div class="toast" id="toast"></div>

        <script>
            // Theme toggle
            const themeBtn = document.getElementById('themeBtn');
            const themeIcon = document.getElementById('themeIcon');
            const currentTheme = localStorage.getItem('theme') || 'light';

            document.documentElement.setAttribute('data-theme', currentTheme);
            themeIcon.textContent = currentTheme === 'dark' ? '◐' : '◑';

            // 添加图标颜色样式，确保在不同主题下都清晰可见
            themeIcon.style.color = currentTheme === 'dark' ? '#ffffff' : '#000000';

            themeBtn.addEventListener('click', () => {
                const theme = document.documentElement.getAttribute('data-theme');
                const newTheme = theme === 'dark' ? 'light' : 'dark';

                document.documentElement.setAttribute('data-theme', newTheme);
                localStorage.setItem('theme', newTheme);
                themeIcon.textContent = newTheme === 'dark' ? '◐' : '◑';
                themeIcon.style.color = newTheme === 'dark' ? '#ffffff' : '#000000';
            });

            // Template Library - 从独立JS文件加载
            // templates对象现在从prompt-templates.js文件中加载

            let currentTemplate = null;

            // Render templates
            function renderTemplates(filteredTemplates = null) {
                const grid = document.getElementById('templatesGrid');
                const templatesToRender = filteredTemplates || window.templates;

                grid.innerHTML = Object.entries(templatesToRender).map(([id, template]) => `
                <div class="template-card" onclick="showTemplateModal('${id}')">
                    ${template.cover ? `
                        <div class="template-cover">
                            <img src="${template.cover}" alt="${template.name}" onerror="this.parentElement.innerHTML='<div class=\'template-icon\'>${template.icon}</div>'">
                        </div>
                    ` : `<div class="template-icon">${template.icon}</div>`}
                    <div class="template-name">${template.name}</div>
                    <div class="template-desc">${template.desc}</div>
                    <div class="template-tags">
                        ${template.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
                    </div>
                </div>
            `).join('');
            }

            // Filter templates by category
            function filterTemplates(category) {
                // Update active filter button
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.querySelector(`[data-category="${category}"]`).classList.add('active');

                // Filter templates
                let filteredTemplates = {};

                if (category === 'all') {
                    filteredTemplates = window.templates;
                } else {
                    Object.entries(window.templates).forEach(([id, template]) => {
                        if (template.category === category) {
                            filteredTemplates[id] = template;
                        }
                    });
                }

                // Re-render templates with filtered results
                renderTemplates(filteredTemplates);
            }

            // Switch tabs
            function switchTab(tab) {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

                event.target.classList.add('active');
                document.getElementById(tab).classList.add('active');

                if (tab === 'templates' && document.getElementById('templatesGrid').children.length === 0) {
                    renderTemplates();
                }
            }

            // Show template modal
            function showTemplateModal(templateId) {
                const template = window.templates[templateId];
                if (!template) return;

                currentTemplate = template;
                document.getElementById('modalTitle').textContent = template.name;
                document.getElementById('modalTemplate').textContent = template.content;
                document.getElementById('templateModal').classList.add('show');
            }

            function closeModal() {
                document.getElementById('templateModal').classList.remove('show');
                currentTemplate = null;
            }

            function copyTemplate() {
                if (!currentTemplate) return;
                navigator.clipboard.writeText(currentTemplate.content);
                showToast('模板已复制到剪贴板');
            }

            // Initialize template selector
            function initializeTemplateSelector() {
                const templateSelect = document.getElementById('templateSelect');
                templateSelect.innerHTML = '<option value="">请选择模板...</option>';

                Object.entries(window.templates).forEach(([id, template]) => {
                    const option = document.createElement('option');
                    option.value = id;
                    option.textContent = template.name;
                    templateSelect.appendChild(option);
                });
            }

            // Initialize on page load
            document.addEventListener('DOMContentLoaded', function () {
                // 等待所有脚本加载完成后再初始化
                if (typeof window.templates !== 'undefined' && Object.keys(window.templates).length > 0) {
                    initializeTemplateSelector();
                } else {
                    console.warn('Templates not loaded yet, retrying...');
                    // 如果templates未定义，等待一段时间后重试
                    setTimeout(() => {
                        if (typeof window.templates !== 'undefined' && Object.keys(window.templates).length > 0) {
                            initializeTemplateSelector();
                        } else {
                            console.error('Failed to load templates from prompt-templates.js');
                            showToast('模板加载失败，请刷新页面重试');
                        }
                    }, 100);
                }
            });

            // Load template and generate dynamic form with enhanced error handling
            function loadTemplate() {
                try {
                    const templateId = document.getElementById('templateSelect').value;
                    const dynamicForm = document.getElementById('dynamicForm');

                    if (!dynamicForm) {
                        console.error('Dynamic form element not found');
                        return;
                    }

                    if (!templateId) {
                        // Reset to empty state
                        dynamicForm.innerHTML = `
                            <div class="empty-state">
                                <div style="text-align: center; padding: 3rem 0; color: var(--text-dim);">
                                    <div style="font-size: 3rem; margin-bottom: 1rem;">📝</div>
                                    <h3 style="margin-bottom: 1rem; color: var(--text);">选择模板开始使用</h3>
                                    <p>请从上方选择模板</p>
                                </div>
                            </div>
                        `;
                        return;
                    }

                    const template = window.templates[templateId];
                    if (!template) {
                        console.error(`Template with ID "${templateId}" not found`);
                        dynamicForm.innerHTML = '<div class="error-message">模板加载失败，请重新选择</div>';
                        return;
                    }

                    // 立即显示完整的模板提示词，让用户了解模板内容
                    document.getElementById('output').value = template.content;

                    // Extract dynamic fields from template content
                    const dynamicFields = extractDynamicFields(template.content);

                    if (dynamicFields.length === 0) {
                        console.warn(`No dynamic fields found in template "${templateId}"`);
                        dynamicForm.innerHTML = '<div class="info-message">此模板无需额外输入，可直接使用</div>';
                        return;
                    }

                    // Generate dynamic form with indicator and enhanced field types
                    let formHTML = '<div class="dynamic-form-indicator">模板模式</div>';

                    dynamicFields.forEach((field, index) => {
                        try {
                            const fieldId = `dynamic_field_${index}`;
                            const requiredAttr = field.required ? 'required' : '';
                            const requiredClass = field.required ? 'required' : '';

                            let inputHTML = '';

                            switch (field.type) {
                                case 'textarea':
                                    inputHTML = `<textarea class="form-textarea" id="${fieldId}" placeholder="${field.placeholder}" ${requiredAttr}></textarea>`;
                                    break;
                                case 'url':
                                    inputHTML = `<input type="url" class="form-input" id="${fieldId}" placeholder="${field.placeholder}" ${requiredAttr}>`;
                                    break;
                                case 'email':
                                    inputHTML = `<input type="email" class="form-input" id="${fieldId}" placeholder="${field.placeholder}" ${requiredAttr}>`;
                                    break;
                                case 'number':
                                    inputHTML = `<input type="number" class="form-input" id="${fieldId}" placeholder="${field.placeholder}" ${requiredAttr}>`;
                                    break;
                                case 'date':
                                    // 自定义日期输入，支持直接输入数字格式如20251208，按回车键后自动识别为2025年12月
                                    inputHTML = `<input type="text" class="form-input" id="${fieldId}" placeholder="请输入日期，按回车键转换：2025年12月 或 20251208" ${requiredAttr} 
                                                 onkeypress="handleDateInputKeyPress(event, this)" maxlength="8">`;
                                    break;
                                default:
                                    inputHTML = `<input type="text" class="form-input" id="${fieldId}" placeholder="${field.placeholder}" ${requiredAttr}>`;
                            }

                            formHTML += `
                            <div class="form-group">
                                <label class="form-label ${requiredClass}">${field.label}${field.required ? ' *' : ''}</label>
                                ${inputHTML}
                            </div>
                        `;
                        } catch (error) {
                            console.error(`Error generating form field for "${field.name}":`, error);
                            // 添加错误字段的后备显示
                            formHTML += `
                            <div class="form-group">
                                <label class="form-label">${field.name}</label>
                                <input type="text" class="form-input" placeholder="请输入${field.name}">
                                <small class="error-text">字段配置错误，使用默认设置</small>
                            </div>
                        `;
                        }
                    });

                    dynamicForm.innerHTML = formHTML;
                    console.info(`Successfully loaded template "${templateId}" with ${dynamicFields.length} fields`);

                } catch (error) {
                    console.error('Error in loadTemplate:', error);
                    const dynamicForm = document.getElementById('dynamicForm');
                    if (dynamicForm) {
                        dynamicForm.innerHTML = '<div class="error-message">模板加载失败，请刷新页面重试</div>';
                    }
                }
            }

            // Extract dynamic fields from template content with enhanced recognition
            function extractDynamicFields(content) {
                try {
                    const fields = [];
                    const fieldPattern = /\[([^\]]+)\]/g;
                    const matches = [...content.matchAll(fieldPattern)];

                    if (matches.length === 0) {
                        console.info('No dynamic fields found in template');
                        return fields;
                    }

                    const uniqueFields = [...new Set(matches.map(match => match[1]))];
                    console.info(`Found ${uniqueFields.length} unique dynamic fields:`, uniqueFields);

                    uniqueFields.forEach(fieldName => {
                        try {
                            const fieldConfig = analyzeFieldType(fieldName);
                            fields.push({
                                name: fieldName,
                                label: fieldConfig.label,
                                placeholder: fieldConfig.placeholder,
                                type: fieldConfig.type,

                                required: fieldConfig.required
                            });
                        } catch (error) {
                            console.error(`Error analyzing field type for "${fieldName}":`, error);
                            // 使用默认配置作为后备
                            fields.push({
                                name: fieldName,
                                label: fieldName,
                                placeholder: `请输入${fieldName}`,
                                type: 'text',
                                required: true
                            });
                        }
                    });

                    return fields;
                } catch (error) {
                    console.error('Error in extractDynamicFields:', error);
                    return [];
                }
            }

            // Analyze field type and configuration based on field name
            function analyzeFieldType(fieldName) {
                // 定义字段类型配置映射表，便于维护和扩展
                const fieldTypeMap = {
                    url: {
                        keywords: ['网址', '链接', 'URL', 'url', '地址'],
                        config: {
                            type: 'url',
                            placeholder: '请输入完整的网址，如：https://example.com',
                            required: true
                        }
                    },
                    text: {
                        keywords: ['名称', '标题', '工具名', '姓名', '用户名'],
                        config: {
                            type: 'text',
                            placeholder: '请输入{fieldName}',
                            required: true
                        }
                    },
                    textarea: {
                        keywords: ['描述', '介绍', '说明', '内容', '特点', '功能', '要求', '需求', '条件', '详情'],
                        config: {
                            type: 'textarea',
                            placeholder: '请详细描述{fieldName}',
                            required: true
                        }
                    },
                    number: {
                        keywords: ['编号', '序号', 'ID', '数量', '年龄', '价格'],
                        config: {
                            type: 'number',
                            placeholder: '请输入{fieldName}',
                            required: true
                        }
                    },
                    email: {
                        keywords: ['邮箱', '邮件', 'email', 'Email'],
                        config: {
                            type: 'email',
                            placeholder: '请输入邮箱地址',
                            required: true
                        }
                    },
                    date: {
                        keywords: ['日期', '时间', 'date', 'Date', '发表时间', '发布时间'],
                        config: {
                            type: 'date',
                            placeholder: '请输入日期，按回车键转换：2025年12月 或 20251208',
                            required: true
                        }
                    }
                };

                // 默认配置
                let config = {
                    label: fieldName,
                    placeholder: `请输入${fieldName}`,
                    type: 'text',
                    required: true
                };

                // 遍历字段类型映射表，匹配字段类型
                for (const [type, typeConfig] of Object.entries(fieldTypeMap)) {
                    if (typeConfig.keywords.some(keyword => fieldName.includes(keyword))) {
                        config = {
                            ...config,
                            ...typeConfig.config,
                            placeholder: typeConfig.config.placeholder.replace('{fieldName}', fieldName)
                        };
                        break;
                    }
                }

                // 特殊处理：可选字段识别
                if (fieldName.includes('可选') || fieldName.includes('选填') || fieldName.includes('(可选)') || fieldName.includes('（可选）')) {
                    config.required = false;
                }

                return config;
            }

            function useTemplate() {
                if (!currentTemplate) return;

                // Switch to generator tab first
                document.querySelectorAll('.tab')[0].click();

                // Find template ID by comparing template objects
                const templateId = Object.keys(window.templates).find(key =>
                    window.templates[key].name === currentTemplate.name &&
                    window.templates[key].content === currentTemplate.content
                );

                if (templateId) {
                    // Set template in selector
                    document.getElementById('templateSelect').value = templateId;

                    // Load the template form
                    loadTemplate();
                }

                closeModal();
                showToast('模板已加载到智能生成器');
            }

            // Generate prompt
            function generatePrompt() {
                const templateId = document.getElementById('templateSelect').value;

                // Check if template is selected
                if (!templateId) {
                    showToast('请先选择一个模板', 'error');
                    return;
                }

                // 使用特定模板生成
                generateFromTemplate(templateId);
            }

            function generateFromTemplate(templateId) {
                try {
                    const template = window.templates[templateId];
                    if (!template) {
                        console.error(`Template not found: ${templateId}`);
                        showToast('模板未找到，请重新选择');
                        return;
                    }

                    let content = template.content;
                    const dynamicFields = extractDynamicFields(content);

                    // 验证必填字段
                    const missingFields = [];
                    const fieldValues = {};
                    let hasValidationError = false;

                    dynamicFields.forEach((field, index) => {
                        const fieldId = `dynamic_field_${index}`;
                        const element = document.getElementById(fieldId);
                        if (!element) {
                            console.warn(`Field element not found: ${fieldId}`);
                            return;
                        }

                        const value = element.value.trim();

                        // 重置错误样式
                        element.style.borderColor = '';

                        // 检查必填字段
                        if (field.required && !value) {
                            missingFields.push(field.label);
                            element.style.borderColor = '#ff4757';
                            hasValidationError = true;
                            return;
                        }

                        // 验证URL格式
                        if (field.type === 'url' && value && !isValidUrl(value)) {
                            showToast(`${field.label} 格式不正确，请输入有效的网址`);
                            element.style.borderColor = '#ff4757';
                            hasValidationError = true;
                            return;
                        }

                        // 验证邮箱格式
                        if (field.type === 'email' && value && !isValidEmail(value)) {
                            showToast(`${field.label} 格式不正确，请输入有效的邮箱地址`);
                            element.style.borderColor = '#ff4757';
                            hasValidationError = true;
                            return;
                        }

                        fieldValues[field.name] = value || field.placeholder;
                    });

                    // 如果有验证错误，停止处理
                    if (hasValidationError) {
                        return;
                    }

                    // 如果有必填字段未填写，显示错误信息
                    if (missingFields.length > 0) {
                        showToast(`请填写必填字段：${missingFields.join('、')}`);
                        return;
                    }

                    // 替换模板中的动态字段
                    Object.entries(fieldValues).forEach(([fieldName, value]) => {
                        const pattern = new RegExp(`\\[${fieldName.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}\\]`, 'g');
                        content = content.replace(pattern, value);
                    });

                    // 检查是否还有未替换的字段
                    const remainingFields = content.match(/\[[^\]]+\]/g);
                    if (remainingFields) {
                        console.warn('Unprocessed fields found:', remainingFields);
                    }

                    document.getElementById('output').value = content;
                    showToast('基于模板生成成功！');

                } catch (error) {
                    console.error('Error in generateFromTemplate:', error);
                    showToast('生成过程中出现错误，请重试');
                }
            }

            // 验证URL格式
            function isValidUrl(string) {
                try {
                    new URL(string);
                    return true;
                } catch (_) {
                    return false;
                }
            }

            // 验证邮箱格式
            function isValidEmail(email) {
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return emailRegex.test(email);
            }

            // 处理日期输入按键事件 - 按回车键后触发格式转换
            function handleDateInputKeyPress(event, input) {
                // 只处理回车键（Enter）
                if (event.key !== 'Enter') {
                    return;
                }

                // 阻止默认行为
                event.preventDefault();

                // 调用格式转换函数
                formatDateInput(input);
            }

            // 日期输入格式化函数 - 支持直接输入数字格式自动识别
            function formatDateInput(input) {
                const value = input.value.trim();

                // 如果输入为空，直接返回
                if (!value) return;

                // 如果已经是中文格式（包含年或月），不做处理
                if (value.includes('年') || value.includes('月')) {
                    return;
                }

                // 处理数字格式：20251208 -> 2025年12月
                if (/^\d{8}$/.test(value)) {
                    const year = value.substring(0, 4);
                    const month = value.substring(4, 6);
                    const day = value.substring(6, 8);

                    // 验证日期的有效性
                    const yearNum = parseInt(year);
                    const monthNum = parseInt(month);
                    const dayNum = parseInt(day);

                    if (yearNum >= 1900 && yearNum <= 2100 &&
                        monthNum >= 1 && monthNum <= 12 &&
                        dayNum >= 1 && dayNum <= 31) {
                        // 转换为中文格式，只显示年和月
                        input.value = `${year}年${month}月`;
                        showToast(`已识别：${year}年${month}月`);
                    }
                }
                // 处理简写格式：202512 -> 2025年12月
                else if (/^\d{6}$/.test(value)) {
                    const year = value.substring(0, 4);
                    const month = value.substring(4, 6);

                    const yearNum = parseInt(year);
                    const monthNum = parseInt(month);

                    if (yearNum >= 1900 && yearNum <= 2100 &&
                        monthNum >= 1 && monthNum <= 12) {
                        input.value = `${year}年${month}月`;
                        showToast(`已识别：${year}年${month}月`);
                    }
                }
            }

            function generatePromptContent(topic, taskType, field, style, length, requirements) {
                const taskDescriptions = {
                    'literature-review': '进行全面的文献综述',
                    'hypothesis': '生成研究假设',
                    'methodology': '设计研究方法',
                    'abstract': '撰写学术摘要',
                    'introduction': '撰写引言部分',
                    'discussion': '撰写讨论部分',
                    'analysis': '进行数据分析',
                    'tool-recommendation': '生成科研工具推荐文章'
                };

                const lengthDescriptions = {
                    'short': '简洁明了，字数控制在200-300字',
                    'medium': '详细阐述，字数控制在500-800字',
                    'long': '深入分析，字数控制在1000-1500字'
                };

                const styleDescriptions = {
                    'formal': '使用正式的学术语言，严谨准确',
                    'casual': '使用通俗易懂的语言，便于理解',
                    'technical': '使用专业术语，技术性强'
                };

                // 如果是科研工具推荐，直接返回模板内容
                if (taskType === 'tool-recommendation') {
                    return window.templates['research-tool-recommendation'].content;
                }

                let prompt = `请以${styleDescriptions[style]}的方式，针对"${topic}"这一主题${taskDescriptions[taskType]}。\n\n`;
                prompt += `要求：\n`;
                prompt += `1. 学科领域：${field}\n`;
                prompt += `2. 篇幅：${lengthDescriptions[length]}\n`;
                prompt += `3. 写作风格：${styleDescriptions[style]}\n`;

                if (requirements) {
                    prompt += `4. 额外要求：${requirements}\n`;
                }

                prompt += `\n请确保内容：\n`;
                prompt += `- 逻辑清晰，结构完整\n`;
                prompt += `- 论据充分，有理有据\n`;
                prompt += `- 语言准确，表达专业\n`;
                prompt += `- 符合学术规范和写作标准\n`;

                if (taskType === 'literature-review') {
                    prompt += `\n在综述中请包含：\n`;
                    prompt += `- 研究背景和意义\n`;
                    prompt += `- 国内外研究现状\n`;
                    prompt += `- 研究方法和主要发现\n`;
                    prompt += `- 存在的问题和未来展望\n`;
                }

                return prompt;
            }

            function copyOutput() {
                const output = document.getElementById('output').value;
                if (!output) {
                    showToast('没有可复制的内容');
                    return;
                }
                navigator.clipboard.writeText(output);
                showToast('已复制到剪贴板');
            }

            function savePrompt() {
                const output = document.getElementById('output').value;
                if (!output) {
                    showToast('没有可保存的内容');
                    return;
                }
                const prompts = JSON.parse(localStorage.getItem('savedPrompts') || '[]');
                prompts.unshift({
                    content: output,
                    date: new Date().toLocaleString('zh-CN')
                });
                if (prompts.length > 10) prompts.pop();
                localStorage.setItem('savedPrompts', JSON.stringify(prompts));
                showToast('已保存');
            }

            function clearOutput() {
                document.getElementById('output').value = '';
            }

            function showToast(message) {
                const toast = document.getElementById('toast');
                toast.textContent = message;
                toast.classList.add('show');
                setTimeout(() => {
                    toast.classList.remove('show');
                }, 2000);
            }

            // Make functions global
            window.switchTab = switchTab;
            window.showTemplateModal = showTemplateModal;
            window.closeModal = closeModal;
            window.copyTemplate = copyTemplate;
            window.useTemplate = useTemplate;
            window.generatePrompt = generatePrompt;
            window.copyOutput = copyOutput;
            window.savePrompt = savePrompt;
            window.clearOutput = clearOutput;
            window.filterTemplates = filterTemplates;

            // Click outside modal to close
            document.getElementById('templateModal').addEventListener('click', (e) => {
                if (e.target.id === 'templateModal') {
                    closeModal();
                }
            });

            // 密码验证功能
            const CORRECT_PASSWORD = '962464';
            const PASSWORD_KEY = 'promptGeneratorAuthenticated';
            const PASSWORD_EXPIRY = 24 * 60 * 60 * 1000; // 24小时有效期

            // 检查是否已经验证过
            function checkAuthentication() {
                const authData = localStorage.getItem(PASSWORD_KEY);
                if (!authData) return false;

                try {
                    const { timestamp } = JSON.parse(authData);
                    const now = new Date().getTime();

                    // 检查是否过期
                    if (now - timestamp > PASSWORD_EXPIRY) {
                        localStorage.removeItem(PASSWORD_KEY);
                        return false;
                    }

                    return true;
                } catch (e) {
                    localStorage.removeItem(PASSWORD_KEY);
                    return false;
                }
            }

            // 验证密码
            function checkPassword() {
                const input = document.getElementById('passwordInput');
                const error = document.getElementById('passwordError');
                const password = input.value.trim();

                if (password === CORRECT_PASSWORD) {
                    // 保存验证状态
                    const authData = {
                        timestamp: new Date().getTime(),
                        authenticated: true
                    };
                    localStorage.setItem(PASSWORD_KEY, JSON.stringify(authData));

                    // 隐藏密码模态框，显示主要内容
                    document.getElementById('passwordModal').style.display = 'none';
                    document.getElementById('mainContent').classList.add('authenticated');

                    showToast('验证成功！欢迎使用学术提示词生成器');
                } else {
                    error.style.display = 'block';
                    input.style.borderColor = '#ff4757';

                    // 显示错误提示，不自动清空输入，方便用户修改
                    setTimeout(() => {
                        error.style.display = 'none';
                        input.style.borderColor = '';
                    }, 3000);
                }
            }

            // 回车键验证
            document.getElementById('passwordInput').addEventListener('keypress', function (e) {
                if (e.key === 'Enter') {
                    checkPassword();
                }
            });

            // 页面加载时检查验证状态
            window.addEventListener('DOMContentLoaded', function () {
                if (checkAuthentication()) {
                    // 已经验证过，直接显示内容
                    document.getElementById('passwordModal').style.display = 'none';
                    document.getElementById('mainContent').classList.add('authenticated');
                } else {
                    // 需要验证，显示密码模态框
                    document.getElementById('passwordModal').style.display = 'flex';
                    document.getElementById('passwordInput').focus();
                }
            });

            // 使密码验证函数全局可用
            window.checkPassword = checkPassword;
        </script>
        <script src="prompt-templates.js"></script>
</body>

</html>